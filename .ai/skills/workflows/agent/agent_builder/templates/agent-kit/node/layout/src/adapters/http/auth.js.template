function checkAuth({ manifest, reqHeaders }) {
  const auth = manifest?.api?.auth || { kind: 'none' };
  const kind = auth.kind || 'none';

  if (kind === 'none') return { ok: true };
  if (kind === 'internal_gateway') return { ok: true }; // assumed handled upstream

  const apiKey = auth.env_var ? process.env[auth.env_var] : null;
  if (!apiKey) return { ok: true }; // allow local dev when not set

  // Accept either Authorization: Bearer <key> or x-api-key: <key>
  const h = {};
  for (const [k, v] of Object.entries(reqHeaders || {})) h[k.toLowerCase()] = String(v);

  const authHeader = h['authorization'] || '';
  const xApiKey = h['x-api-key'] || '';
  const token = authHeader.toLowerCase().startsWith('bearer ') ? authHeader.slice(7).trim() : '';

  if (token === apiKey || xApiKey === apiKey) return { ok: true };

  return { ok: false, status: 401, message: 'Unauthorized' };
}

module.exports = { checkAuth };
